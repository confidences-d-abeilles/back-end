<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: models/base.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: models/base.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>
const R = require('ramda');
const { logDebug } = require('@cda/logger');

const { getClient } = require('../database');

class BaseModel {
  /**
   * @constructor
   * @param {string} tableName
   * @param {string[]} fields
   * @param {Object&lt;string,*>} data
   */
  constructor(tableName, fields, data) {
    this.fields = fields;
    this.dbFields = fields.map((field) => `${tableName}.${field}`);
    this.tableName = tableName;
    Object.assign(this, R.pick(this.fields, data));
  }

  /**
   * Return one instance of the class, matching the criteria given by fields
   *
   * @async
   * @param {Object&lt;string,*>} fields To be passed to the where clause
   * @param {Object} opts Options
   * @param {boolean} [opts.toJson=true] If you intend to make some operations on the entity,
   * should be forced to false
   * @returns {Promise&lt;null|*>}
   */
  async findOne(fields, { toJson } = { toJson: true }) {
    logDebug(`Finding ${this.tableName}`);
    const client = getClient();
    const rows = await client.where(fields).select(this.fields).from(this.tableName);
    logDebug('Success');
    if (!rows[0]) {
      return null;
    }
    const res = new this.constructor(rows[0]);
    return toJson ? res.toJson() : res;
  }

  /**
   * Delete the current instance from database
   *
   * @async
   * @returns {Promise&lt;void>}
   */
  async delete() {
    logDebug(`Deleting ${this.tableName}`);
    const client = getClient();
    await client.where(this.toJson()).from(this.tableName).del();
    logDebug('Success');
  }

  /**
   *
   * @param {Object&lt;string,*>} fields To be passed to the where clause
   * @returns {Promise&lt;Object[]>}
   */
  async find(fields = {}) {
    logDebug(`Finding ${this.tableName}`);
    const client = getClient();
    const rows = await client.where(fields).select(this.dbFields).from(this.tableName);
    logDebug('Success');
    if (!rows.length) {
      return [];
    }
    return rows.map((row) => new this.constructor(row).toJson());
  }

  async save() {
    const client = getClient();
    logDebug(`Saving ${this.tableName}`);
    if (this.id) {
      const rows = await client.update(R.pick(this.fields, this), ['*']).into(this.tableName).where({ id: this.id });
      Object.assign(this, R.pick(this.fields, rows[0]));
    } else {
      const rows = await client.insert(R.pick(this.fields, this), ['*']).into(this.tableName);
      Object.assign(this, R.pick(this.fields, rows[0]));
    }
    logDebug('Success');
  }

  toJson() {
    return R.pick(this.fields, this);
  }
}

module.exports = BaseModel;
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-data.html">data</a></li><li><a href="module-jwt.html">jwt</a></li></ul><h3>Classes</h3><ul><li><a href="BaseModel.html">BaseModel</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.3</a> on Sun Mar 29 2020 23:46:58 GMT+0200 (Central European Summer Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
